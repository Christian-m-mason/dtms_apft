<html>
<meta charset="UTF-8">
<head>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/index.css">
  <link rel="stylesheet" href="css/theme.bootstrap_4.css">
</head>
<body>

<div class="form-group">
  <label for="dtmsPersReportXslx">Choose the DTMS personnel file</label>
  <input type="file" id="dtmsPersReportXslx" name="dtmsPersReportXslx"/>
</div>

<div class="form-group">
  <label for="dtmsApftReportXslx">Choose the DTMS APFT report to process</label>
  <input type="file" id="dtmsApftReportXslx" name="dtmsApftReportXslx"/>
</div>

<div class="form-group">
  <button id="displayApftStats" type="button" class="btn btn-primary btn-lg">Display APFT Statistics</button>
</div>

<table id="apftComplianceTable" class="table table-dark table-bordered tablesorter" > </table> 
<table id="personTable" class="table table-dark table-bordered" > </table> 

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/jquery.csv.min.js"></script>
<script src="js/luxon.min.js"></script>
<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<script src="js/d3.v5.min.js"></script>
<script src="js/jquery.tablesorter.min.js"></script>

<script>
var DateTime = luxon.DateTime
var dtmsPersReport = []
var dtmsApftReport = []

// create the dtmsPersReport from the Xslx file
// this is the personnel report from DTMS
$('#dtmsPersReportXslx').on('change', function(event) {
  var dtmsPersReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var binary = ""
    var bytes = new Uint8Array(e.target.result)
    var length = bytes.byteLength
    for (var i = 0; i < length; i += 1) {
      binary += String.fromCharCode(bytes[i])
    }
    var workbook = XLSX.read(binary, { 
      type: 'binary', 
      cellDates: true,
    })
    dtmsPersReport = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

    dtmsPersReport = dtmsPersReport.filter(removeDACivilians)
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsArrayBuffer(dtmsPersReportFile)
})

// this contains personnel apft records
$('#dtmsApftReportXslx').on('change', function(event) {
  var dtmsApftReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    binary = ""
    bytes = new Uint8Array(e.target.result)
    length = bytes.byteLength
    for (var i = 0; i < length; i += 1) {
      binary += String.fromCharCode(bytes[i])
    }
    workbook = XLSX.read(binary, {
      type: 'binary',
      cellDates: true,
    })
    dtmsApftReport = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

    // create a luxon DateTime named 'parsedLastApft' from the 'LastApft' JS Date
    dtmsApftReport = dtmsApftReport.map(setParsedLastApft)
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsArrayBuffer(dtmsApftReportFile)
})

function setParsedLastApft(apftRecord) {
  apftRecord['parsedLastApft'] = DateTime.fromJSDate(apftRecord['LastApft'])
  return apftRecord
}

function removeDACivilians (record) {
  return record['RankShort'].indexOf('GS') === -1
}

function getDTMSUnits (units, record) {
  // check to see if the 'UnitAttached' is not undefined and length > 0
  if (record['UnitAttached'] !== undefined && record['UnitAttached'].length > 0) {
    if (!units.includes(record['UnitAttached'])) {
      units.push(record['UnitAttached'])
    }
    return units
  }
  if (!units.includes(record['UnitAssigned'])) {
    units.push(record['UnitAssigned'])
  }
  return units
}

function generateApftTable (dtmsPersReport, dtmsApftReport) {
  let apftTable = document.getElementById('apftComplianceTable') 

  while(apftTable.hasChildNodes()) {
    apftTable.removeChild(apftTable.firstChild);
  }

  let apftTableHead = apftTable.createTHead()
  let apftTableHeadRow = apftTableHead.insertRow(-1)
  let apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Unit'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Complete/Req'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Due within 30 days'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Number Alt Events'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Average PU Score'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Average SU Score'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Average Run Score'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Average Score'

  let apftTableBody = document.createElement('tbody')

  // get the list of units from the dtmsPersReport

  // use the 'UnitAttached' if exists, then use the 'UnitAssigned'
  let dtmsUnitArray = dtmsPersReport.reduce(getDTMSUnits,[])

  // sort the units alphabetically
  dtmsUnitArray.sort()

  dtmsUnitArray.forEach(function (unit) {
    // on the export, do all Soldiers have records?

    // first, make the list of all Soldiers in the unit, then find their apft scores, it is ok if a Soldier doesn't have a pt score, just print blank

    let soldierList = dtmsPersReport.filter(getUnitSoldierList, unit)

    // make another function to enrich the 'soldierList' with apft data

    soldierList = soldierList.map(addApftRecordData)

    apftTableRow = apftTableBody.insertRow(-1)
    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = unit
    apftTableCell.setAttribute('data-unit',unit)
    apftTableCell.setAttribute('data-column','unit')
    apftTableCell.onclick = cellClickHandler

    apftTableCell = apftTableRow.insertCell(-1)
    let completeApft = soldierList.filter(isSoldierCurrentApft).length
    let requiredApft = soldierList.length
    apftTableCell.innerHTML = `${Math.round(completeApft*100/requiredApft)}% (${completeApft} / ${requiredApft})`;
    apftTableCell.setAttribute('data-unit',unit)
    apftTableCell.setAttribute('data-column','current')
    apftTableCell.onclick = cellClickHandler

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = soldierList.filter(isSoldierDueWithin30Days).length.toString()
    apftTableCell.setAttribute('data-unit',unit)
    apftTableCell.setAttribute('data-column','dueWithin30Days')
    apftTableCell.onclick = cellClickHandler

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = soldierList.filter(isAltEvent).length.toString()
    apftTableCell.setAttribute('data-unit',unit)
    apftTableCell.setAttribute('data-column','altEvent')
    apftTableCell.onclick = cellClickHandler

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = Math.round(getEventScoreAverage(soldierList, 'PushupScore')).toString()
    apftTableCell.setAttribute('data-unit',unit)

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = Math.round(getEventScoreAverage(soldierList, 'SitupScore')).toString()
    apftTableCell.setAttribute('data-unit',unit)

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = Math.round(getEventScoreAverage(soldierList, 'RunScore')).toString()
    apftTableCell.setAttribute('data-unit',unit)

    // to calculate the average score, sum the averages
    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = Math.round(getScoreAverage(soldierList)).toString()
    apftTableCell.setAttribute('data-unit',unit)
  })

  // generate stats for all Soldiers

  // need to make a 'getSoldiers' function that returns the apft records for all Soldiers in the unit
  let allSoldiers = dtmsPersReport

  // make a row that has the totals
  apftTableRow = apftTableBody.insertRow(-1)
  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = 'All'
  apftTableCell.setAttribute('data-unit','All')
  apftTableCell.setAttribute('data-column','unit')
  apftTableCell.onclick = cellClickHandler

  apftTableCell = apftTableRow.insertCell(-1)
  completeApft = allSoldiers.filter(isSoldierCurrentApft).length
  requiredApft = allSoldiers.length
  apftTableCell.innerHTML = `${Math.round(completeApft*100/requiredApft)}% (${completeApft} / ${requiredApft})`;
  apftTableCell.setAttribute('data-unit','All')
  apftTableCell.setAttribute('data-column','current')
  apftTableCell.onclick = cellClickHandler

  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = allSoldiers.filter(isSoldierDueWithin30Days).length.toString()
  apftTableCell.setAttribute('data-unit','All')
  apftTableCell.setAttribute('data-column','dueWithin30Days')
  apftTableCell.onclick = cellClickHandler

  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = allSoldiers.filter(isAltEvent).length.toString()
  apftTableCell.setAttribute('data-unit','All')
  apftTableCell.setAttribute('data-column','altEvent')
  apftTableCell.onclick = cellClickHandler

  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = Math.round(getEventScoreAverage(allSoldiers, 'PushupScore')).toString()
  apftTableCell.setAttribute('data-unit','All')

  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = Math.round(getEventScoreAverage(allSoldiers, 'SitupScore')).toString()
  apftTableCell.setAttribute('data-unit','All')

  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = Math.round(getEventScoreAverage(allSoldiers, 'RunScore')).toString()
  apftTableCell.setAttribute('data-unit','All')

  // to calculate the average score, sum the averages
  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = Math.round(getScoreAverage(allSoldiers)).toString()
  apftTableCell.setAttribute('data-unit','All')

  apftTable.appendChild(apftTableBody)
}

function getSoldierApftRecord (apftRecord) {
  return (apftRecord['Last4'] === this['Last4'] && apftRecord['LastName'] === this['LastName'])
}

// only pull data from the dtmsApftReport that is needed for the apft record
function addApftRecordData (soldierRecord) {
  // check to see if there is any soldier data in the dtmsApftReport
  let soldierApftRecord = dtmsApftReport.filter(getSoldierApftRecord, { Last4: soldierRecord['Last4'], LastName: soldierRecord['LastName'] })
  // for now, assume that the first record found is the only record, use the most recent record in the future
  if (soldierApftRecord.length > 0) {
    soldierRecord['Age'] = soldierApftRecord[0]['Age']
    soldierRecord['ForRecord'] = soldierApftRecord[0]['ForRecord']
    soldierRecord['IsAlternative'] = soldierApftRecord[0]['IsAlternative']
    soldierRecord['LastApft'] = soldierApftRecord[0]['LastApft']
    soldierRecord['PassFail'] = soldierApftRecord[0]['PassFail']
    soldierRecord['PushupRaw'] = soldierApftRecord[0]['PushupRaw']
    soldierRecord['PushupScore'] = soldierApftRecord[0]['PushupScore']
    soldierRecord['RawRun'] = soldierApftRecord[0]['RawRun']
    soldierRecord['RunScore'] = soldierApftRecord[0]['RunScore']
    soldierRecord['Score'] = soldierApftRecord[0]['Score']
    soldierRecord['Sex'] = soldierApftRecord[0]['Sex']
    soldierRecord['SitupRaw'] = soldierApftRecord[0]['SitupRaw']
    soldierRecord['SitupScore'] = soldierApftRecord[0]['SitupScore']
    soldierRecord['parsedLastApft'] = soldierApftRecord[0]['parsedLastApft']
  } else {
    soldierRecord['Age'] = ''
    soldierRecord['ForRecord'] = false
    soldierRecord['IsAlternative'] = ''
    soldierRecord['LastApft'] = ''
    soldierRecord['PassFail'] = ''
    soldierRecord['PushupRaw'] = ''
    soldierRecord['PushupScore'] = 0
    soldierRecord['RawRun'] = ''
    soldierRecord['RunScore'] = 0
    soldierRecord['Score'] = ''
    soldierRecord['Sex'] = ''
    soldierRecord['SitupRaw'] = ''
    soldierRecord['SitupScore'] = 0
    soldierRecord['parsedLastApft'] = ''
  }
  return soldierRecord
}

function cellClickHandler (e) {
  let unitText = e.srcElement.getAttribute('data-unit')
  let columnText = e.srcElement.getAttribute('data-column')
  let soldierList = []
  if (unitText === 'All') {
    soldierList = dtmsPersReport
  } else {
    soldierList = dtmsPersReport.filter(getUnitSoldierList, unitText)
  }

  // check to see what column of data is requested
  if (columnText === 'dueWithin30Days') {
    soldierList = soldierList.filter(isSoldierDueWithin30Days)
  } else if (columnText === 'current') {
    soldierList = soldierList.filter(isSoldierCurrentApft)
  } else if (columnText === 'altEvent') {
    soldierList = soldierList.filter(isAltEvent)
  } else {
    soldierList = soldierList
  }
  displayPersonList(soldierList)
}

function displayPersonList (soldierList) {
  let personTable = document.getElementById('personTable')

  while(personTable.hasChildNodes()) {
    personTable.removeChild(personTable.firstChild);
  }

  let personTableHeader = personTable.createTHead()
  let personTableHeaderRow = personTableHeader.insertRow(-1)
  let personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Rank'

  personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Name'

  personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Unit'

  personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Date of Last APFT'

  personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Score'

  let personTableBody = document.createElement('tbody')
  personTable.appendChild(personTableBody)

  let personTableBodyRow
  let personTableBodyCell

  soldierList.forEach(function (soldier) {
    personTableBodyRow = personTableBody.insertRow(-1)

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    personTableBodyCell.innerHTML = soldier['RankShort']

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    personTableBodyCell.innerHTML = soldier['LastName']

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    personTableBodyCell.innerHTML = soldier['UnitAssigned']

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    if (soldier['parsedLastApft'] !== undefined) {
      personTableBodyCell.innerHTML = soldier['parsedLastApft'].toFormat('MM/dd/yyyy')
    }

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    if (soldier['Score'] !== undefined) {
      personTableBodyCell.innerHTML = soldier['Score']
    }
  })
  // after the first load, use 'updateAll' to refresh the table sort
  $("#personTable").tablesorter({
    theme: 'bootstrap',
    sortReset: true,
    sortRestart: true,
  })
  $("#personTable").trigger("updateAll")
}

function getUnitSoldierList (persRecord) {
  // check to see if the soldier is attached to the unit, if attached to a unit, then he should not be listed on the 'assigned' roster
  try {
    if (persRecord['UnitAttached'].length > 0) {
      return persRecord['UnitAttached'] === this.toString()
    }
  } catch (e) {
  }
  return persRecord['UnitAssigned'] === this.toString()
}

function isSoldierDueWithin30Days (apftRecord) {
  return (apftRecord['parsedLastApft'] === undefined || apftRecord['parsedLastApft'].plus({ months: 5 }) <= luxon.DateTime.local())
}

function isSoldierCurrentApft (apftRecord) {
  return ((apftRecord['parsedLastApft'] !== undefined) && (apftRecord['parsedLastApft'].plus({ months: 6 }) >= luxon.DateTime.local()))
}

function isAltEvent (apftRecord) {
    return apftRecord['IsAlternative']
}

function addScores({ totalScore, scoreCount }, score) {
  return {
    totalScore: totalScore + score,
    scoreCount: scoreCount + 1,
  }
}

function isRecordScore (apftRecord) {
  return apftRecord['ForRecord']
}

function getScoreAverage (soldierList) {
  let puScore = getEventScoreAverage(soldierList, 'PushupScore')
  let suScore = getEventScoreAverage(soldierList, 'SitupScore')
  let runScore = getEventScoreAverage(soldierList, 'RunScore')
  // round the event averages before summing them so the integers that appear in each column sum to the average
  let roundedAverage = Math.round(puScore) + Math.round(suScore) + Math.round(runScore)
  return roundedAverage
}

function getScore (apftRecord) {
  return apftRecord[this.toString()]
}

function scoreAboveZero (apftRecord) {
  return (apftRecord[this.toString()] > 0)
}

function getEventScoreAverage (soldierList, eventType) {
  const initialInfo = { totalScore: 0, scoreCount: 0 }
  const scoreInfo = soldierList.filter(isRecordScore)
    .filter(scoreAboveZero, eventType)
    .map(getScore, eventType)
    .reduce(addScores, initialInfo)

  const {totalScore, scoreCount} = scoreInfo
  let averageScore = totalScore / scoreCount
  if (isNaN(averageScore)) {
    averageScore = 0
  }
  return averageScore
}

// by team, by person
$('#displayApftStats').on('click', function () {
  // this function will build the html table to show the training data
  generateApftTable(dtmsPersReport, dtmsApftReport)
  $("#apftComplianceTable").tablesorter({
    theme: 'bootstrap',
    sortReset: true,
    sortRestart: true,
  })
  $("#apftComplianceTable").trigger("updateAll")

})

</script>
</body>
</html>
