<html>
<meta charset="UTF-8">
<head>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/index.css">
  <link rel="stylesheet" href="css/theme.bootstrap_4.css">
</head>
<body>

<div class="form-group">
  <label for="dtmsPersReportXslx">Choose the DTMS personnel file</label>
  <input type="file" id="dtmsPersReportXslx" name="dtmsPersReportXslx"/>
</div>

<div class="form-group">
  <label for="dtmsApftReportXslx">Choose the DTMS APFT report to process</label>
  <input type="file" id="dtmsApftReportXslx" name="dtmsApftReportXslx"/>
</div>

<div class="form-group">
  <button id="displayApftStats" type="button" class="btn btn-primary btn-lg">Display APFT Statistics</button>
</div>

<table id="apftComplianceTable" class="table table-dark table-bordered tablesorter" > </table> 
<table id="personTable" class="table table-dark table-bordered" > </table> 

<script src="js/jquery-3.4.1.min.js"></script>
<script src="js/jquery.csv.min.js"></script>
<script src="js/luxon.min.js"></script>
<script src="js/jszip.js"></script>
<script src="js/xlsx.js"></script>
<script src="js/d3.v5.min.js"></script>
<script src="js/jquery.tablesorter.min.js"></script>

<script>
var DateTime = luxon.DateTime
var dtmsPersReport = []
var dtmsApftReport = []
var dtmsUnits = []

// create the dtmsPersReport from the Xslx file
// this is the personnel report from DTMS
$('#dtmsPersReportXslx').on('change', function(event) {
  var dtmsPersReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    var binary = ""
    var bytes = new Uint8Array(e.target.result)
    var length = bytes.byteLength
    for (var i = 0; i < length; i += 1) {
      binary += String.fromCharCode(bytes[i])
    }
    var workbook = XLSX.read(binary, { 
      type: 'binary', 
      cellDates: true,
    })
    dtmsPersReport = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

    dtmsPersReport = dtmsPersReport.filter(filterOutDACivilians)
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsArrayBuffer(dtmsPersReportFile)
})

// this contains personnel apft records
$('#dtmsApftReportXslx').on('change', function(event) {
  var dtmsApftReportFile = event.target.files[0]
  var reader = new FileReader()
  reader.onload = function (e) {
    binary = ""
    bytes = new Uint8Array(e.target.result)
    length = bytes.byteLength
    for (var i = 0; i < length; i += 1) {
      binary += String.fromCharCode(bytes[i])
    }
    workbook = XLSX.read(binary, {
      type: 'binary',
      cellDates: true,
    })
    dtmsApftReport = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
    // sort by date trained and remove duplicate person entries from the tng report
    // only interested in the latest date trained

    // create a luxon DateTime named 'parsedLastApft' from the 'LastApft' JS Date
    dtmsApftReport = dtmsApftReport.map(setParsedLastApft)

    // add the apft records to the dtmsUnits data structure
    addApftToUnits(dtmsPersReport, dtmsApftReport)

    // get the list of units
    let dtmsUnitArray = dtmsPersReport.reduce(getDTMSUnits,[])
    
  }
  reader.onerror = function (ex) {
    console.log(ex)
  }
  reader.readAsArrayBuffer(dtmsApftReportFile)
})

function setParsedLastApft(apftRecord) {
  apftRecord['parsedLastApft'] = DateTime.fromJSDate(apftRecord['LastApft'])
  return apftRecord
}

function filterOutDACivilians (record) {
  return record['RankShort'].indexOf('GS') === -1
}

// addApftToUnits to add apft stats to the unit
function addApftToUnits (dtmsPersReport, dtmsApftReport) {
  dtmsApftReport.forEach(function (apftRecord) {
    dtmsPersReport.forEach(function (soldier) {
      if (soldier['LastName'] === apftRecord['LastName'] && soldier['Last4'] === apftRecord['Last4']) {
        soldier['Age'] = apftRecord['Age']
        soldier['ForRecord'] = apftRecord['ForRecord']
        soldier['IsAlternative'] = apftRecord['IsAlternative']
        soldier['LastApft'] = apftRecord['LastApft']
        soldier['PassFail'] = apftRecord['PassFail']
        soldier['PushupRaw'] = apftRecord['PushupRaw']
        soldier['PushupScore'] = apftRecord['PushupScore']
        soldier['RawRun'] = apftRecord['RawRun']
        soldier['RunScore'] = apftRecord['RunScore']
        soldier['Score'] = apftRecord['Score']
        soldier['Sex'] = apftRecord['Sex']
        soldier['SitupRaw'] = apftRecord['SitupRaw']
        soldier['SitupScore'] = apftRecord['SitupScore']
        soldier['parsedLastApft'] = apftRecord['parsedLastApft']
      }
    })
  })
}

function getDTMSUnits (units, record) {
  if (!units.includes(record['UnitAssigned'])) {
    units.push(record['UnitAssigned'])
  }
  return units
}

function generateApftTable (dtmsUnits) {
  let apftTable = document.getElementById('apftComplianceTable') 

  while(apftTable.hasChildNodes()) {
    apftTable.removeChild(apftTable.firstChild);
  }

  let apftTableHead = apftTable.createTHead()
  let apftTableHeadRow = apftTableHead.insertRow(-1)
  let apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Unit'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Complete/Req'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Due within 30 days'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Number Alt Events'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Average PU Score'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Average SU Score'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Average Run Score'

  apftTableHeadCell = apftTableHeadRow.insertCell(-1)
  apftTableHeadCell.innerHTML = 'Average Score'

  let apftTableBody = document.createElement('tbody')
  let dtmsUnitArray = dtmsPersReport.reduce(getDTMSUnits,[])

  dtmsUnitArray.forEach(function (unit) {
    apftTableRow = apftTableBody.insertRow(-1)
    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = unit
    let soldierList = getSoldierListForUnit(unit)

    apftTableCell = apftTableRow.insertCell(-1)
    let completeApft = getSoldiersWithValidApft(soldierList)
    let requiredApft = soldierList.length
    apftTableCell.innerHTML = `${Math.round(completeApft*100/requiredApft)}% (${completeApft} / ${requiredApft})`;
    apftTableCell.setAttribute('data-unit',unit)

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = getSoldiersDueWithin30Days(soldierList).toString()
    apftTableCell.setAttribute('data-unit',unit)
    apftTableCell.onclick = within30DaysClickHandler

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = getNumAltEvents(soldierList).toString()
    apftTableCell.setAttribute('data-unit',unit)

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = Math.round(getPUScoreAverage(soldierList)).toString()
    apftTableCell.setAttribute('data-unit',unit)

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = Math.round(getSUScoreAverage(soldierList)).toString()
    apftTableCell.setAttribute('data-unit',unit)

    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = Math.round(getRunScoreAverage(soldierList)).toString()
    apftTableCell.setAttribute('data-unit',unit)

    // to calculate the average score, sum the averages
    apftTableCell = apftTableRow.insertCell(-1)
    apftTableCell.innerHTML = Math.round(getScoreAverage(soldierList)).toString()
    apftTableCell.setAttribute('data-unit',unit)
  })

  // make a row that has the totals
  apftTableRow = apftTableBody.insertRow(-1)
  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = 'All'
  let allSoldiers = getSoldierListForUnit('All')

  apftTableCell = apftTableRow.insertCell(-1)
  completeApft = getSoldiersWithValidApft(allSoldiers)
  requiredApft = allSoldiers.length
  apftTableCell.innerHTML = `${Math.round(completeApft*100/requiredApft)}% (${completeApft} / ${requiredApft})`;
  apftTableCell.setAttribute('data-unit','All')

  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = getSoldiersDueWithin30Days(allSoldiers).toString()
  apftTableCell.setAttribute('data-unit','All')
  apftTableCell.onclick = within30DaysClickHandler


  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = getNumAltEvents(allSoldiers).toString()
  apftTableCell.setAttribute('data-unit','All')

  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = Math.round(getPUScoreAverage(allSoldiers)).toString()
  apftTableCell.setAttribute('data-unit','All')

  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = Math.round(getSUScoreAverage(allSoldiers)).toString()
  apftTableCell.setAttribute('data-unit','All')

  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = Math.round(getRunScoreAverage(allSoldiers)).toString()
  apftTableCell.setAttribute('data-unit','All')

  // to calculate the average score, sum the averages
  apftTableCell = apftTableRow.insertCell(-1)
  apftTableCell.innerHTML = Math.round(getScoreAverage(allSoldiers)).toString()
  apftTableCell.setAttribute('data-unit','All')

  apftTable.appendChild(apftTableBody)
}

function within30DaysClickHandler (e) {
  let unitText = e.srcElement.getAttribute('data-unit')
  let soldierList = getSoldierListForUnit(unitText)
  let soldierListDueWithin30Days = getSoldierListDueWithin30Days(soldierList)
  displayPersonList(soldierListDueWithin30Days)
}

function getUnitSoldierList (apftRecord) {
  return apftRecord['UnitAssigned'] === this.toString()
}

function getSoldierListForUnit (unitText) {
  let unitObj = []
  if (unitText === 'All') {
    return dtmsPersReport
  } else {
    return dtmsPersReport.filter(getUnitSoldierList, unitText)
  }
}


function displayPersonList (soldierList) {
  let personTable = document.getElementById('personTable')

  while(personTable.hasChildNodes()) {
    personTable.removeChild(personTable.firstChild);
  }

  let personTableHeader = personTable.createTHead()
  let personTableHeaderRow = personTableHeader.insertRow(-1)
  let personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Rank'

  personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Name'

  personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Unit'

  personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Date of Last APFT'

  personTableHeaderCell = personTableHeaderRow.insertCell(-1)
  personTableHeaderCell.innerHTML = 'Score'

  let personTableBody = document.createElement('tbody')
  personTable.appendChild(personTableBody)

  let personTableBodyRow
  let personTableBodyCell

  soldierList.forEach(function (soldier) {
    personTableBodyRow = personTableBody.insertRow(-1)

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    personTableBodyCell.innerHTML = soldier['RankShort']

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    personTableBodyCell.innerHTML = soldier['LastName']

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    personTableBodyCell.innerHTML = soldier['UnitAssigned']

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    if (soldier['parsedLastApft'] !== undefined) {
      personTableBodyCell.innerHTML = soldier['parsedLastApft'].toFormat('MM/dd/yyyy')
    }

    personTableBodyCell = personTableBodyRow.insertCell(-1)
    if (soldier['Score'] !== undefined) {
      personTableBodyCell.innerHTML = soldier['Score']
    }
  })
  // after the first load, the table sorter does not load
  $("#personTable").tablesorter({
    theme: 'bootstrap',
    sortReset: true,
    sortRestart: true,
  })
  $("#personTable").trigger("updateAll")
}

function isSoldierDueWithin30Days (apftRecord) {
  return (apftRecord['parsedLastApft'] === undefined || apftRecord['parsedLastApft'].plus({ months: 5 }) <= luxon.DateTime.local())
}

function isSoldierCurrentApft (apftRecord) {
  return ((apftRecord['parsedLastApft'] !== undefined) && (apftRecord['parsedLastApft'].plus({ months: 6 }) >= luxon.DateTime.local()))
}

function getSoldierListDueWithin30Days (soldierList) {
  // get all Soldiers in the unit with an APFT that will expire within 30 days
  return soldierList.filter(isSoldierDueWithin30Days)
}

function getSoldiersDueWithin30Days (soldierList) {
  // get all Soldiers in the unit that are due for an APFT in the next 30 days, including those without an APFT
  return soldierList.filter(isSoldierDueWithin30Days).length
}

function getSoldierListWithValidApft (soldierList) {
  // get all Soldiers in the unit with an APFT that is less than 6 months old
  return soldierList.filter(isSoldierCurrentApft)
}

function getSoldiersWithValidApft (soldierList) {
  // get all Soldiers in the unit with an APFT that is less than 6 months old
  return soldierList.filter(isSoldierCurrentApft).length
}

function isAltEvent (apftRecord) {
    return apftRecord['IsAlternative']
}

function getNumAltEvents (soldierList) {
  return soldierList.filter(isAltEvent).length
}

function addScores({ totalScore, scoreCount }, score) {
  return {
    totalScore: totalScore + score,
    scoreCount: scoreCount + 1,
  }
}

function getPUScore (apftRecord) {
  return apftRecord['PushupScore']
}

function getSUScore (apftRecord) {
  return apftRecord['SitupScore']
}

function getRunScore (apftRecord) {
  return apftRecord['RunScore']
}

function isRecordScore (apftRecord) {
  return apftRecord['ForRecord']
}

function puScoreAboveZero (apftRecord) {
  return (apftRecord['PushupScore'] > 0)
}

function suScoreAboveZero (apftRecord) {
  return (apftRecord['SitupScore'] > 0)
}

function runScoreAboveZero (apftRecord) {
  return (apftRecord['RunScore'] > 0)
}


function getScoreAverage (soldierList) {
  let puScore = getPUScoreAverage(soldierList)
  let suScore = getSUScoreAverage(soldierList)
  let runScore = getRunScoreAverage(soldierList)
  let average = puScore + suScore + runScore
  return average
}


function getPUScoreAverage (soldierList) {
  const initialInfo = { totalScore: 0, scoreCount: 0 }
  const scoreInfo = soldierList.filter(isRecordScore)
    .filter(puScoreAboveZero)
    .map(getPUScore)
    .reduce(addScores, initialInfo)

  const {totalScore, scoreCount} = scoreInfo
  const averageScore = totalScore / scoreCount
  return averageScore
}

function getSUScoreAverage (soldierList) {
  const initialInfo = { totalScore: 0, scoreCount: 0 }
  const scoreInfo = soldierList.filter(isRecordScore)
    .filter(suScoreAboveZero)
    .map(getSUScore)
    .reduce(addScores, initialInfo)

  const {totalScore, scoreCount} = scoreInfo
  const averageScore = totalScore / scoreCount
  return averageScore
}

function getRunScoreAverage (soldierList) {
  const initialInfo = { totalScore: 0, scoreCount: 0 }
  const scoreInfo = soldierList.filter(isRecordScore)
    .filter(runScoreAboveZero)
    .map(getRunScore)
    .reduce(addScores, initialInfo)

  const {totalScore, scoreCount} = scoreInfo
  const averageScore = totalScore / scoreCount
  return averageScore
}

// by team, by person
$('#displayApftStats').on('click', function () {
  // this function will build the html table to show the training data
  generateApftTable(dtmsUnits)
  $("#apftComplianceTable").tablesorter({
    theme: 'bootstrap',
    sortReset: true,
    sortRestart: true,
  })
  $("#apftComplianceTable").trigger("updateAll")

})

// SORT FUNCTIONS 
function sortByUnit (sort_file) {
  // sort by the unit
  sort_file.sort( function(a, b) {
    return (a.unit.localeCompare(b.unit))
  })
  return sort_file
}

function unitExists(unitName) {
  return dtmsUnits.some(function(el) {
    return el.unit === unitName
  })  
}
</script>
</body>
</html>
